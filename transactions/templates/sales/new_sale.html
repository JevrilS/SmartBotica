{% extends "base.html" %}
{% block title %}New Sale{% endblock title %}

{% block content %}
<h2>Log New Sale</h2>

<form method="post" action="{% url 'new-sale' %}" id="sale-form">
    {% csrf_token %}
    {{ form.as_p }}

    <div>
        <h3>Add Product</h3>
        {{ sale_item_form.product_id.label_tag }}
        {{ sale_item_form.product_id }}
        {{ sale_item_form.quantity.label_tag }}
        {{ sale_item_form.quantity }}
        <button type="button" id="add-to-list" class="btn btn-primary">Add to List</button>
        <button type="button" id="clear-list" class="btn btn-secondary">Clear</button>
    </div>

    <div>
        <h3>Selected Products</h3>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Total</th>
                </tr>
            </thead>
            <tbody id="selected-products">
                {% for item in selected_items %}
                    <tr>
                        <td>{{ item.product_name }}</td>
                        <td>{{ item.quantity }}</td>
                        <td>{{ item.price }}</td>
                        <td>{{ item.total }}</td>
                    </tr>
                {% empty %}
                    <tr><td colspan="4">No products added yet.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Replace the submit button with a regular button to control submission with JavaScript -->
    <button type="button" class="btn btn-success" id="complete-sale">Complete Sale</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    $('#add-to-list').click(function() {
        const product_id = $('#id_product_id').val();
        const quantity = $('#id_quantity').val();
        
        if (product_id && quantity) {
            $.ajax({
                url: '{% url "add-to-selected-items" %}',
                type: 'POST',
                data: {
                    'product_id': product_id,
                    'quantity': quantity,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    alert(response.message);
                    location.reload();
                },
                error: function(xhr) {
                    const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : "An error occurred.";
                    alert("Error: " + errorMessage);
                }
            });
        } else {
            alert("Please select a product and enter quantity.");
        }
    });

    $('#clear-list').click(function() {
        $.ajax({
            url: '{% url "clear-selected-items" %}',
            type: 'POST',
            data: {
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                alert(response.message);
                location.reload();
            },
            error: function(xhr) {
                const errorMessage = xhr.responseJSON ? xhr.responseJSON.error : "An error occurred.";
                alert("Error: " + errorMessage);
            }
        });
    });

    // JavaScript to handle complete sale submission
    $('#complete-sale').click(function() {
        // Check if there are items in the selected products list
        const hasItems = $('#selected-products tr').length > 1;
        if (!hasItems) {
            alert("No items selected for sale.");
            return;
        }
        
        // Submit the form to complete the sale
        $('#sale-form').submit();
    });
});
</script>
{% endblock content %}
